<div class="page">

  <div class="page-header">
    <div>
      <h1 class="title">My rides</h1>
      <p class="subtitle">View your assigned rides and manage the ride status.</p>
    </div>
  </div>

  <!-- current ride -->
  <div class="section" *ngIf="activeRide as ar">
    <h2 class="section-title">Active ride</h2>

    <div class="ride-card active">
      <div class="ride-top">
        <div class="ride-meta">
          <span class="badge active-badge">In progress</span>
          <span class="time">{{ ar.scheduledTime }}</span>
          <span class="price">{{ ar.price }} RSD</span>
        </div>

        <div class="ride-actions">
          <button
            class="btn danger"
            [class.disabled]="ar.panic"
            [disabled]="ar.panic"
            (click)="panic(ar)"
          >
          {{ ar.panic ? 'PANIC active' : 'PANIC' }}
        </button>

          <button class="btn gray" (click)="openStopModal(ar)">
            Stop
          </button>

          <button class="btn primary" (click)="finishRide(ar)">
            End ride
          </button>
        </div>
      </div>

      <div class="ride-body">
        <div class="col">
          <div class="label">From</div>
          <div class="value">{{ ar.from.address }}</div>
        </div>

        <div class="col">
          <div class="label">To</div>
          <div class="value">{{ ar.to.address }}</div>
        </div>

        <div class="col" *ngIf="ar.stops.length > 0">
          <div class="label">Additional stops</div>
          <div class="value">
            <div class="stop" *ngFor="let s of ar.stops">• {{ s.address }}</div>
          </div>
        </div>

        <div class="col">
          <div class="label">Passengers</div>
          <div class="chips">
            <span class="chip" *ngFor="let p of ar.passengers">{{ p }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- upcoming rides -->
  <div class="section">
    <h2 class="section-title">Upcoming rides</h2>

    <div class="empty" *ngIf="!upcomingRides || upcomingRides.length === 0">
      No upcoming rides at the moment.
    </div> 

    <div class="ride-list" *ngIf="upcomingRides.length > 0">
      <div class="ride-card" *ngFor="let r of upcomingRides">
        <div class="ride-top">
          <div class="ride-meta">
            <span class="badge upcoming-badge">Upcoming</span>
            <span class="time">{{ r.scheduledTime }}</span>
            <span class="price">{{ r.price }} RSD</span>
          </div>

          <div class="ride-actions">
            <button
              class="btn primary"
              [class.disabled]="!r.allPassengersJoined"
              [disabled]="!r.allPassengersJoined || hasActiveRide"
              (click)="startRide(r)"
            >
              Start
            </button>

            

            <button
              class="btn gray"
              [class.disabled]="r.allPassengersJoined"
              [disabled]="r.allPassengersJoined"
              (click)="openCancelModal(r)"
            >
              Cancel
            </button>
          </div>
        </div>

        <div class="ride-body">
          <div class="col">
            <div class="label">From</div>
            <div class="value">{{ r.from.address }}</div>
          </div>

          <div class="col">
            <div class="label">To</div>
            <div class="value">{{ r.to.address }}</div>
          </div>

          <div class="col" *ngIf="r.stops.length > 0">
            <div class="label">Additional stops</div>
            <div class="value">
              <div class="stop" *ngFor="let s of r.stops">• {{ s.address }}</div>
            </div>
          </div>

          <div class="col">
            <div class="passengers-header">
                <div class="label">Passengers</div>

                <div class="arrived-text" [class.ok]="r.allPassengersJoined">
                    {{ r.allPassengersJoined ? 'Passengers have arrived' : "Passengers haven't arrived yet" }}
                </div>
                </div>

                <div class="chips">
                <span class="chip" *ngFor="let p of r.passengers">{{ p }}</span>
                </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop" *ngIf="showCancelModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title">Cancel ride</div>
        <button class="x-btn" type="button" (click)="closeCancelModal()">✕</button>
      </div>

      <div class="modal-body">
        <div class="modal-subtitle" *ngIf="cancelRideTarget as cr">
          {{ cr.from.address }} → {{ cr.to.address }}
        </div>

        <form [formGroup]="cancelForm" (ngSubmit)="confirmCancel()">
          <label class="modal-label">Reason for cancellation</label>
          <textarea
            class="modal-textarea"
            rows="4"
            formControlName="reason"
            placeholder="Write a short reason (min 5 characters)..."
          ></textarea>

          <div class="modal-error" *ngIf="reason.touched && reason.invalid">
            <span *ngIf="reason.errors?.['required']">Reason is required.</span>
            <span *ngIf="reason.errors?.['minlength']">Minimum 5 characters.</span>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn gray" (click)="closeCancelModal()">
              Back
            </button>

            <button type="submit" class="btn danger">
              Confirm cancel
            </button>
          </div>
          </form>
        </div>
    </div>
  </div>
  </div>

  <!-- STOP MODAL (keep OUTSIDE other modals) -->
<app-stop-ride
  *ngIf="showStopModal && stopRideTarget as sr"
  [rideId]="sr.id"
  [currentPrice]="sr.price"
  (close)="closeStopModal()"
  (confirm)="onStopConfirmed($event)"
></app-stop-ride>


